# Valida o arquivo pt-br.tsv quando modificado
# Verifica estrutura TSV, encoding UTF-8 e consist√™ncia

name: Validate pt-br.tsv

on:
  push:
    paths:
      - 'pt-br.tsv'
      - '.github/workflows/validate_tsv.yml'
      - '.github/scripts/validate_tsv.py'
  pull_request:
    paths:
      - 'pt-br.tsv'
      - '.github/workflows/validate_tsv.yml'
      - '.github/scripts/validate_tsv.py'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate TSV structure
        run: |
          echo "üìã Validando estrutura do pt-br.tsv..."
          
          # Verifica se arquivo existe
          if [ ! -f pt-br.tsv ]; then
            echo "‚ùå Arquivo pt-br.tsv n√£o encontrado!"
            exit 1
          fi
          
          # Conta linhas
          LINES=$(wc -l < pt-br.tsv)
          echo "   üìÑ Total de linhas: $LINES"
          
          # Verifica encoding UTF-8
          if file pt-br.tsv | grep -q "UTF-8"; then
            echo "   ‚úÖ Encoding: UTF-8"
          else
            echo "   ‚ö†Ô∏è Encoding pode n√£o ser UTF-8"
          fi
          
          # Verifica se todas as linhas t√™m TAB
          LINES_WITHOUT_TAB=$(grep -cv $'\t' pt-br.tsv || true)
          if [ "$LINES_WITHOUT_TAB" -gt 0 ]; then
            echo "   ‚ö†Ô∏è $LINES_WITHOUT_TAB linhas sem TAB (pode ser header ou linhas vazias)"
          else
            echo "   ‚úÖ Todas as linhas t√™m estrutura TSV"
          fi
          
          # Verifica linhas com n√∫mero incorreto de colunas
          EXPECTED_COLS=2
          WRONG_COLS=$(awk -F'\t' -v exp="$EXPECTED_COLS" 'NF != exp {count++} END {print count+0}' pt-br.tsv)
          if [ "$WRONG_COLS" -gt 0 ]; then
            echo "   ‚ö†Ô∏è $WRONG_COLS linhas com n√∫mero de colunas diferente de $EXPECTED_COLS"
          else
            echo "   ‚úÖ Todas as linhas t√™m $EXPECTED_COLS colunas"
          fi
          
          echo ""
          echo "‚úÖ Valida√ß√£o conclu√≠da!"

      - name: Check for duplicate IDs
        run: |
          echo "üîç Verificando IDs duplicados..."
          
          # Extrai primeira coluna (IDs) e encontra duplicados
          DUPLICATES=$(cut -f1 pt-br.tsv | sort | uniq -d)
          
          if [ -n "$DUPLICATES" ]; then
            echo "‚ö†Ô∏è IDs duplicados encontrados:"
            echo "$DUPLICATES" | head -20
            DUPE_COUNT=$(echo "$DUPLICATES" | wc -l)
            if [ "$DUPE_COUNT" -gt 20 ]; then
              echo "... e mais $((DUPE_COUNT - 20)) duplicados"
            fi
          else
            echo "‚úÖ Nenhum ID duplicado encontrado"
          fi
