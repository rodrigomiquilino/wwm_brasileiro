# Recebe atualiza√ß√µes do gloss√°rio via repository_dispatch
# e atualiza docs/glossary.json automaticamente
#
# REPOSIT√ìRIO: wwm_brasileiro
# Disparado pelo glossary-admin.js quando admin salva altera√ß√µes

name: Update Glossary

on:
  repository_dispatch:
    types: [update-glossary]

# ========== FILA AUTOM√ÅTICA ==========
# Evita conflitos quando v√°rias edi√ß√µes s√£o feitas rapidamente
concurrency:
  group: update-glossary-queue
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      
      - name: Display update info
        run: |
          echo "üìö Atualizando gloss√°rio..."
          echo "Termos: ${{ github.event.client_payload.terms_count }}"
          echo "Disparado por: @${{ github.event.client_payload.triggered_by }}"
          echo "A√ß√£o: ${{ github.event.client_payload.action }}"
      
      - name: Update glossary.json
        run: |
          # Decodifica o conte√∫do base64 do glossary
          echo '${{ github.event.client_payload.glossary_base64 }}' | base64 -d > docs/glossary.json
          
          # Valida se √© JSON v√°lido
          if ! jq empty docs/glossary.json 2>/dev/null; then
            echo "‚ùå JSON inv√°lido!"
            exit 1
          fi
          
          # Mostra stats
          TERMS=$(jq '.terms | length' docs/glossary.json)
          echo "‚úÖ Gloss√°rio v√°lido com $TERMS termos"
      
      - name: Check for changes
        id: git-check
        run: |
          git diff --quiet docs/glossary.json && echo "changed=false" >> $GITHUB_OUTPUT || echo "changed=true" >> $GITHUB_OUTPUT
      
      - name: Commit changes
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add docs/glossary.json
          
          # Mensagem de commit baseada na a√ß√£o
          ACTION="${{ github.event.client_payload.action }}"
          TERM_ID="${{ github.event.client_payload.term_id }}"
          
          case "$ACTION" in
            "add")
              MSG="üìö Gloss√°rio: Adicionado termo \`$TERM_ID\`"
              ;;
            "edit")
              MSG="üìö Gloss√°rio: Editado termo \`$TERM_ID\`"
              ;;
            "delete")
              MSG="üìö Gloss√°rio: Removido termo \`$TERM_ID\`"
              ;;
            "rename")
              MSG="üìö Gloss√°rio: Renomeado \`${{ github.event.client_payload.old_id }}\` ‚Üí \`$TERM_ID\`"
              ;;
            *)
              MSG="üìö Gloss√°rio: Atualiza√ß√£o geral"
              ;;
          esac
          
          git commit -m "$MSG

          Disparado via glossary-admin por @${{ github.event.client_payload.triggered_by }}"
          
          # ========== PUSH COM RETRY ==========
          for attempt in 1 2 3; do
            echo "üì§ Tentativa $attempt de push..."
            git pull --rebase origin main 2>/dev/null || true
            if git push origin main; then
              echo "‚úÖ Push realizado com sucesso!"
              break
            else
              if [ $attempt -lt 3 ]; then
                echo "‚ö†Ô∏è Falha no push, aguardando $((attempt * 2))s..."
                sleep $((attempt * 2))
              else
                echo "‚ùå Falha ap√≥s 3 tentativas"
                exit 1
              fi
            fi
          done
      
      - name: No changes needed
        if: steps.git-check.outputs.changed == 'false'
        run: |
          echo "‚ÑπÔ∏è Nenhuma altera√ß√£o detectada no gloss√°rio."

