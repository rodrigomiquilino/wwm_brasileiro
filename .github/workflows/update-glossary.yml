# Recebe atualizaÃ§Ãµes do glossÃ¡rio via repository_dispatch
# e atualiza docs/glossary.json automaticamente
#
# REPOSITÃ“RIO: wwm_brasileiro
# Disparado pelo glossary-admin.js quando admin salva alteraÃ§Ãµes

name: Update Glossary

on:
  repository_dispatch:
    types: [update-glossary]

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      
      - name: Display update info
        run: |
          echo "ğŸ“š Atualizando glossÃ¡rio..."
          echo "Termos: ${{ github.event.client_payload.terms_count }}"
          echo "Disparado por: @${{ github.event.client_payload.triggered_by }}"
          echo "AÃ§Ã£o: ${{ github.event.client_payload.action }}"
      
      - name: Update glossary.json
        run: |
          # Decodifica o conteÃºdo base64 do glossary
          echo '${{ github.event.client_payload.glossary_base64 }}' | base64 -d > docs/glossary.json
          
          # Valida se Ã© JSON vÃ¡lido
          if ! jq empty docs/glossary.json 2>/dev/null; then
            echo "âŒ JSON invÃ¡lido!"
            exit 1
          fi
          
          # Mostra stats
          TERMS=$(jq '.terms | length' docs/glossary.json)
          echo "âœ… GlossÃ¡rio vÃ¡lido com $TERMS termos"
      
      - name: Check for changes
        id: git-check
        run: |
          git diff --quiet docs/glossary.json && echo "changed=false" >> $GITHUB_OUTPUT || echo "changed=true" >> $GITHUB_OUTPUT
      
      - name: Commit changes
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add docs/glossary.json
          
          # Mensagem de commit baseada na aÃ§Ã£o
          ACTION="${{ github.event.client_payload.action }}"
          TERM_ID="${{ github.event.client_payload.term_id }}"
          
          case "$ACTION" in
            "add")
              MSG="ğŸ“š GlossÃ¡rio: Adicionado termo \`$TERM_ID\`"
              ;;
            "edit")
              MSG="ğŸ“š GlossÃ¡rio: Editado termo \`$TERM_ID\`"
              ;;
            "delete")
              MSG="ğŸ“š GlossÃ¡rio: Removido termo \`$TERM_ID\`"
              ;;
            "rename")
              MSG="ğŸ“š GlossÃ¡rio: Renomeado \`${{ github.event.client_payload.old_id }}\` â†’ \`$TERM_ID\`"
              ;;
            *)
              MSG="ğŸ“š GlossÃ¡rio: AtualizaÃ§Ã£o geral"
              ;;
          esac
          
          git commit -m "$MSG

          Disparado via glossary-admin por @${{ github.event.client_payload.triggered_by }}"
          git push origin main
          
          echo "âœ… Commit realizado!"
      
      - name: No changes needed
        if: steps.git-check.outputs.changed == 'false'
        run: |
          echo "â„¹ï¸ Nenhuma alteraÃ§Ã£o detectada no glossÃ¡rio."
